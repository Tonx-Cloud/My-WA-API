# ConfiguraÃ§Ã£o do Alertmanager para My-WA-API
# Gerenciamento e roteamento de alertas

global:
  # ConfiguraÃ§Ãµes SMTP para email
  smtp_smarthost: '${SMTP_HOST}:${SMTP_PORT}'
  smtp_from: '${EMAIL_FROM}'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASS}'

  # URLs base para templates
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# Templates customizados
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ConfiguraÃ§Ã£o de rotas
route:
  # Receptor padrÃ£o
  receiver: 'default'

  # Tempo para agrupar alertas
  group_wait: 10s
  group_interval: 5m
  repeat_interval: 4h

  # Agrupamento de alertas
  group_by: ['alertname', 'severity', 'service']

  # Rotas especÃ­ficas
  routes:
    # Alertas crÃ­ticos - notificaÃ§Ã£o imediata
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 30m
      routes:
        # API crÃ­tica - Slack + Email + SMS
        - match:
            service: api
          receiver: 'api-critical'
        # Banco crÃ­tico - DBA team
        - match:
            service: database
          receiver: 'database-critical'

    # Alertas de warning - notificaÃ§Ã£o agrupada
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      group_interval: 10m
      repeat_interval: 2h

    # Alertas de infraestrutura
    - match:
        component: system
      receiver: 'infrastructure-alerts'
      group_interval: 15m

    # Alertas de WhatsApp
    - match:
        service: whatsapp
      receiver: 'whatsapp-alerts'
      group_interval: 5m

# ConfiguraÃ§Ãµes de inibiÃ§Ã£o
inhibit_rules:
  # Se API estÃ¡ down, nÃ£o alertar sobre latÃªncia
  - source_match:
      alertname: 'APIDown'
    target_match:
      alertname: 'APIHighLatency'
    equal: ['service']

  # Se container estÃ¡ reiniciando, nÃ£o alertar sobre saÃºde
  - source_match:
      alertname: 'ContainerRestarting'
    target_match_re:
      alertname: '.*Down'
    equal: ['instance']

# ConfiguraÃ§Ãµes de receptores
receivers:
  # Receptor padrÃ£o (silencioso)
  - name: 'default'
    webhook_configs:
      - url: 'http://localhost:9093/api/v1/silence'
        send_resolved: true

  # Alertas crÃ­ticos - mÃºltiplos canais
  - name: 'critical-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts-critical'
        title: 'ðŸš¨ ALERTA CRÃTICO - My-WA-API'
        text: |
          *Alerta:* {{ .GroupLabels.alertname }}
          *Severidade:* {{ .GroupLabels.severity }}
          *ServiÃ§o:* {{ .GroupLabels.service }}
          *DescriÃ§Ã£o:* {{ range .Alerts }}{{ .Annotations.description }}{{ end }}
          *HorÃ¡rio:* {{ range .Alerts }}{{ .StartsAt.Format "15:04:05 02/01/2006" }}{{ end }}
        send_resolved: true
        title_link: 'http://localhost:3030/d/my-wa-api'

    email_configs:
      - to: '${ALERT_EMAIL_CRITICAL}'
        subject: 'ðŸš¨ ALERTA CRÃTICO - My-WA-API - {{ .GroupLabels.alertname }}'
        body: |
          Alerta crÃ­tico detectado no My-WA-API:

          Alerta: {{ .GroupLabels.alertname }}
          Severidade: {{ .GroupLabels.severity }}
          ServiÃ§o: {{ .GroupLabels.service }}

          Detalhes:
          {{ range .Alerts }}
          - {{ .Annotations.summary }}
          - {{ .Annotations.description }}
          - InÃ­cio: {{ .StartsAt.Format "15:04:05 02/01/2006" }}
          {{ end }}

          Dashboard: http://localhost:3030/d/my-wa-api
          Alertmanager: http://localhost:9093
        send_resolved: true

  # Alertas especÃ­ficos da API
  - name: 'api-critical'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#api-alerts'
        title: 'ðŸ”¥ API CRÃTICA - My-WA-API'
        text: |
          *API EM ESTADO CRÃTICO!*

          {{ range .Alerts }}
          *Problema:* {{ .Annotations.summary }}
          *Detalhes:* {{ .Annotations.description }}
          *InÃ­cio:* {{ .StartsAt.Format "15:04:05 02/01/2006" }}
          {{ end }}

          <http://localhost:3030/d/api-dashboard|ðŸ“Š Dashboard API>
          <http://localhost:9093|ðŸš¨ Alertmanager>
        send_resolved: true
        color: 'danger'

    webhook_configs:
      - url: '${DISCORD_WEBHOOK_URL}/slack'
        send_resolved: true

  # Alertas de banco de dados
  - name: 'database-critical'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#database-alerts'
        title: 'ðŸ’¾ BANCO CRÃTICO - My-WA-API'
        text: |
          *PROBLEMA NO BANCO DE DADOS!*

          {{ range .Alerts }}
          *Problema:* {{ .Annotations.summary }}
          *Detalhes:* {{ .Annotations.description }}
          {{ end }}
        send_resolved: true
        color: 'danger'

  # Alertas de warning
  - name: 'warning-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts'
        title: 'âš ï¸ Alerta - My-WA-API'
        text: |
          *Alerta de atenÃ§Ã£o:*

          {{ range .Alerts }}
          â€¢ {{ .Annotations.summary }}
          {{ end }}
        send_resolved: true
        color: 'warning'

  # Alertas de infraestrutura
  - name: 'infrastructure-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#infrastructure'
        title: 'ðŸ–¥ï¸ Infraestrutura - My-WA-API'
        text: |
          *Alerta de infraestrutura:*

          {{ range .Alerts }}
          â€¢ {{ .Annotations.summary }}: {{ .Annotations.description }}
          {{ end }}
        send_resolved: true

  # Alertas do WhatsApp
  - name: 'whatsapp-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#whatsapp'
        title: 'ðŸ’¬ WhatsApp - My-WA-API'
        text: |
          *Alerta do WhatsApp:*

          {{ range .Alerts }}
          â€¢ {{ .Annotations.summary }}
          {{ end }}
        send_resolved: true
        color: 'good'